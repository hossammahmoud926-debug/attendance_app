
<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تسجيل الحضور - <title>
  <style>
    body {
      font-family: "Cairo", sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #e3f2fd);
      text-align: center;
      padding: 40px;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      width: 360px;
      margin: auto;
    }
    input, button {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #0056b3;
    }
    .message {
      margin-top: 15px;
      font-weight: bold;
    }
    .success { color: green; }
    .error { color: red; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="container">
    <h2>تسجيل الحضور</h2>

    <div id="signinDiv"></div>

    <form id="attendanceForm" style="display:none;">
      <label>البريد الإلكتروني:</label><br>
      <input type="email" id="email" readonly><br>

      <label>اسم الدكتور:</label><br>
      <input type="text" id="doctor" placeholder="اكتب اسمك"><br>

      <button type="button" onclick="sendData()">تسجيل الحضور</button>
    </form>

    <div class="message" id="message"></div>
  </div>

  <script>
    const GOOGLE_CLIENT_ID = "786071819345-qiftfnfup45vc92rdg5uvauf81rirt69.apps.googleusercontent.com";
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzd2k7NvDALGQgZD9ha_kF8qU-xjkFR6NeNPQmign0joY__LNlwulBgbNsouJ465tqYGg/exec";

    // تسجيل الدخول بحساب Google
    window.onload = function() {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse
      });
      google.accounts.id.renderButton(
        document.getElementById("signinDiv"),
        { theme: "outline", size: "large", text: "signin_with", shape: "pill" }
      );
    };

    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);
      document.getElementById("email").value = data.email;
      document.getElementById("signinDiv").style.display = "none";
      document.getElementById("attendanceForm").style.display = "block";
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function sendData() {
      const email = document.getElementById("email").value.trim();
      const doctor = document.getElementById("doctor").value.trim();

      if (!doctor) {
        showMessage("⚠️ من فضلك أدخل اسم الدكتور", false);
        return;
      }

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const latitude = pos.coords.latitude;
          const longitude = pos.coords.longitude;

          fetch(WEB_APP_URL, {"https://script.google.com/macros/s/AKfycbzd2k7NvDALGQgZD9ha_kF8qU-xjkFR6NeNPQmign0joY__LNlwulBgbNsouJ465tqYGg/exec";}
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, doctor, latitude, longitude })
          })
          .then(res => res.json())
          .then(data => {
            showMessage(data.message, data.success);
          })
          .catch(err => {
            showMessage("❌ حدث خطأ أثناء الإرسال", false);
            console.error(err);
          });

        }, () => {
          showMessage("⚠️ يجب السماح بالوصول إلى الموقع", false);
        });
      } else {
        showMessage("المتصفح لا يدعم تحديد الموقع", false);
      }
    }

function showMessage(msg, success) {
      const el = document.getElementById("message");
      el.textContent = msg;
      el.className = success ? "message success" : "message error";
    }
  </script>
</body>
</html>
