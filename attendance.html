
.<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta name="google-signin-client_id" content="573694224261-fv08344h3d0u6t8nebmtre9r2fkkoi1l.apps.googleusercontent.com">
  <style>
    body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#e0f7fa,#80deea)}
    #container{background:#fff;padding:28px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,0.15);width:92%;max-width:420px;text-align:center}
    input{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid #ccc;box-sizing:border-box}
    button{width:100%;padding:12px;margin-top:10px;border-radius:8px;border:none;background:#2196f3;color:#fff;font-size:16px;cursor:pointer}
    button:disabled{background:#aaa;cursor:not-allowed}
    #message{min-height:28px;margin-top:14px;font-weight:600}
  </style>
</head>
<body>
  <div id="container">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù</h2>

    <!-- Ø²Ø± Google Sign-In -->
    <div id="googleBtn"></div>

    <!-- Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="formSection" style="display:none">
      <input id="email" type="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" readonly />
      <input id="doctor" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ±" />
      <button id="registerBtn">ØªØ³Ø¬ÙŠÙ„</button>
      <div id="message"></div>
    </div>
  </div>

<script>
/* ------------------------------------------------------------------
  Ø§Ø¶Ø¨Ø· Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Web App Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ùˆ ØªØºÙŠØ±
  (Ø±Ø§Ø¨Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø·ÙŠØªÙ‡: AKfycbx.../exec)
-------------------------------------------------------------------*/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdoe6JtvUtXp6T-swkBzTH229BF3JF6kxPyKaZziypkQRQDlGrKcWUY3ud7BwB4qXlmQ/exec";

/* ------------------------------------------------------------------
  ÙƒÙ„ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† (Ù†Ø³Ø®ØªÙ‡Ø§ ÙƒØ§Ù…Ù„Ø© Ù…Ù† ÙƒÙˆØ¯Ùƒ). Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ¶ÙŠÙ Ø§Ø³Ù…/Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŒ
  Ø¶ÙŠÙ Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯ Ø¨Ù†ÙØ³ Ø§Ù„Ø´ÙƒÙ„ {name, lat, lng}
-------------------------------------------------------------------*/
const places = [
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø§Ù„Ø´ÙˆØ¨Ùƒ Ø§Ù„ØºØ±Ø¨ÙŠ", lat: 29.780919, lng: 31.278475},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø£Ø¨Ùˆ Ø±Ø¬ÙˆØ§Ù† Ù‚Ø¨Ù„ÙŠ", lat: 29.770280, lng: 31.267013},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø§Ù„Ù…Ø±Ø§Ø²ÙŠÙ‚", lat: 29.814147, lng: 31.255456},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: ÙƒÙØ± Ø²Ù‡Ø±Ø§Ù†", lat: 29.813962, lng: 31.267850},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠØ©", lat: 29.772818, lng: 31.274100},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ù†Ø²Ù„Ø© Ø§Ù„Ø´ÙˆØ¨Ùƒ", lat: 29.756137, lng: 31.262556},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø£Ø¨Ùˆ Ø±Ø¬ÙˆØ§Ù† Ø¨Ø­Ø±ÙŠ", lat: 29.787006, lng: 31.269636},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø³Ù‚Ø§Ø±Ø©", lat: 29.854717, lng: 31.228076},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø§Ù„Ø´Ù†Ø¨Ø§Ø¨", lat: 29.831932, lng: 31.256685},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ù…Ù†Ø´Ø£Ø© Ø¯Ù‡Ø´ÙˆØ±", lat: 29.796878, lng: 31.243665},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø¯Ù‡Ø´ÙˆØ±", lat: 29.750484, lng: 31.238552},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ù…Ø²ØºÙˆÙ†Ø©", lat: 29.740945, lng: 31.260663},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø²Ø§ÙˆÙŠØ© Ø¯Ù‡Ø´ÙˆØ±", lat: 29.750894, lng: 31.235090},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø§Ù„Ø±Ø¹Ø§ÙŠØ©", lat: 29.850886, lng: 31.271462},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ù…ÙƒØªØ¨ Ø§Ù„ØµØ­Ø©", lat: 29.850494, lng: 31.271627},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø£Ø¨Ùˆ ØµÙŠØ±", lat: 29.892684, lng: 31.220209},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ù…ÙŠØª Ø±Ù‡ÙŠÙ†Ø©", lat: 29.850584, lng: 31.245046},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ù…Ù†Ø´Ø£Ø© ÙƒØ§Ø³Ø¨", lat: 29.729669, lng: 31.235557},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø´Ù…Ø§", lat: 30.384876, lng: 30.914407},
  {name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©: Ø§Ù„Ø¬Ø¯ÙŠØ¯", lat: 0, lng: 0}
];

/* Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ† Ø¨Ø§Ù„Ù…ØªØ± (Haversine) */
function getDistanceMeters(lat1, lon1, lat2, lon2){
  const R = 6371000; // Ù…ØªØ±
  const toRad = v => v * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}


/* Google Identity initialization */
window.onload = () => {
  google.accounts.id.initialize({
    client_id: "573694224261-fv08344h3d0u6t8nebmtre9r2fkkoi1l.apps.googleusercontent.com",
    callback: handleCredentialResponse
  });
  google.accounts.id.renderButton(document.getElementById("googleBtn"), {theme: "outline", size: "large", text: "continue_with"});
  google.accounts.id.prompt();
};

function handleCredentialResponse(response){
  try {
    const payload = parseJwt(response.credential);
    document.getElementById("email").value = payload.email || "";
    document.getElementById("formSection").style.display = "block";
    document.getElementById("googleBtn").style.display = "none";
  } catch(e){
    console.error(e);
  }
}

/* Ø¨Ø³ÙŠØ· Ù„ÙÙƒ Ø§Ù„Ù€ JWT */
function parseJwt(token){
  const base64Url = token.split('.')[1] || "";
  const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
  const json = decodeURIComponent(atob(base64 || "").split('').map(c=> '%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
  return JSON.parse(json || '{}');
}

/* Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
const btn = document.getElementById("registerBtn");
const msg = document.getElementById("message");

btn.addEventListener("click", () => {
  msg.textContent = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...";
  btn.disabled = true;

  const email = document.getElementById("email").value.trim();
  const doctor = document.getElementById("doctor").value.trim();
  if(!email){
    msg.textContent = "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google Ø£ÙˆÙ„Ø§";
    btn.disabled = false;
    return;
  }
  if(!doctor){
    msg.textContent = "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ±";
    btn.disabled = false;
    return;
  }

  if(!navigator.geolocation){
    msg.textContent = "âš ï¸ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
    btn.disabled = false;
    return;
  }

  navigator.geolocation.getCurrentPosition(position => {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ù…ÙƒØ§Ù† Ø¯Ø§Ø®Ù„ 100 Ù…ØªØ±
    let found = null;
    for(let p of places){
      const d = getDistanceMeters(lat, lng, p.lat, p.lng);
      if(d <= 100){
        found = {place: p.name, distance: Math.round(d)};
        break;
      }
    }

    if(!found){
      msg.textContent = "ğŸš« Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø®Ø¯Ù…Ø© (Ø£Ø¨Ø¹Ø¯ Ù…Ù† 100 Ù…ØªØ±)";
      btn.disabled = false;
      return;
    }

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Apps Script
    const payload = {
      email: email,
      doctor: doctor,
      lat: lat,
      lng: lng,
      place: found.place
    };

    fetch(SCRIPT_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(res => {
      // Ø¥Ø°Ø§ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø±Ø¬Ø¹ Ø±Ø³Ø§Ù„Ø© Ù†Ø§Ø¬Ø­Ø© Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø³Ø§Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      if(res && res.success){
        msg.textContent = "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ ÙÙŠ " + found.place + " âœ“";
      } else if(res && res.message){
        msg.textContent = res.message;
      } else {
        msg.textContent = "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ ÙÙŠ " + found.place + " âœ“";
      }
      btn.disabled = false;
    })
    .catch(err => {
      console.error(err);
      msg.textContent = "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…";
      btn.disabled = false;
    });

  }, err => {
    console.error(err);
    msg.textContent = "âš ï¸ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ â€” Ø§ÙØ­Øµ Ø§Ù„Ø³Ù…Ø§Ø­ÙŠØ§Øª Ø£Ùˆ Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
    btn.disabled = false;
  }, {enableHighAccuracy:true, timeout:15000, maximumAge:0});
});
</script>
</body>
</html>
