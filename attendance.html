<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل حضور وانصراف</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; display: flex; justify-content: center; align-items: center; height: 100vh; }
  .container { background: #fff; padding: 20px 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
  input, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; }
  button { background: #007bff; color: #fff; border: none; cursor: pointer; }
  button:hover { background: #0056b3; }
  .message { margin-top: 15px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
  .message span { font-size: 20px; }
</style>
</head>
<body>
<div class="container">
  <h2>تسجيل حضور وانصراف</h2>

  <!-- زر تسجيل الدخول بـ Google -->
  <div id="g_id_onload"
       data-client_id="573694224261-fv08344h3d0u6t8nebmtre9r2fkkoi1l.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="true">
  </div>
  <div class="g_id_signin" data-type="standard"></div>

  <!-- خانة الإيميل -->
  <input type="email" id="email" placeholder="الإيميل" readonly>

  <!-- خانة اسم الدكتور -->
  <input type="text" id="doctor" placeholder="اسم الدكتور">

  <!-- زر تسجيل -->
  <button id="submitBtn">تسجيل</button>

  <div class="message" id="message"></div>
</div>

<script>
  // بعد تسجيل الدخول بـ Google، يظهر الإيميل تلقائي
  function handleCredentialResponse(response) {
    const jwt = parseJwt(response.credential);
    document.getElementById('email').value = jwt.email;
  }

  // دالة لفك ترميز JWT
  function parseJwt (token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  }

  // زر التسجيل
  document.getElementById('submitBtn').addEventListener('click', function() {
    const email = document.getElementById('email').value;
    const doctor = document.getElementById('doctor').value;

    if (!email) { alert('الرجاء تسجيل الدخول أولاً'); return; }
    if (!doctor) { alert('الرجاء إدخال اسم الدكتور'); return; }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        const webAppUrl = "https://script.google.com/macros/s/AKfycbxdoe6JtvUtXp6T-swkBzTH229BF3JF6kxPyKaZziypkQRQDlGrKcWUY3ud7BwB4qXlmQ/exec";

        fetch(webAppUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, doctor, latitude, longitude })
        })
        .then(response => response.json())
        .then(data => {
          const messageEl = document.getElementById('message');
          if(data.success){
            messageEl.innerHTML = <span>✅</span> ${data.message};
          } else {
            messageEl.innerHTML = <span>❌</span> ${data.message};
          }
        })
        .catch(err => {
          document.getElementById('message').innerHTML = <span>❌</span> حدث خطأ أثناء التسجيل;
          console.error(err);
        });

      }, function(error) {
        alert('الرجاء السماح بالوصول للموقع لتسجيل الحضور');
      });
    } else {
      alert('المتصفح لا يدعم خدمة تحديد الموقع.');
    }
  });
</script>
</body>
</html>
