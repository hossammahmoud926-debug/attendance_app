
// تنسيق الخطأ (أحمر وعلامة خطأ)
                elements.statusIcon.innerHTML = '❌';
                elements.statusContainer.className = 'mt-6 p-6 rounded-xl transition-all duration-300 border-2 border-red-400 bg-red-50';
                elements.statusTextResult.classList.remove('text-green-700');
                elements.statusTextResult.classList.add('text-red-600');
            }
        }

        // دالة رد الاتصال بعد تسجيل الدخول بنجاح من جوجل
        window.handleCredentialResponse = function(response) {
            const responsePayload = parseJwt(response.credential);
            if (responsePayload && responsePayload.email) {
                userData.email = responsePayload.email;
                userData.isLoggedIn = true;
                updateUI();
            } else {
                showStatus(false, 'فشل في الحصول على بيانات المستخدم من جوجل.', 'الرجاء المحاولة مرة أخرى.');
            }
        }

        // الحصول على الإحداثيات الجغرافية
        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("الموقع الجغرافي غير مدعوم في متصفحك."));
                    return;
                }

                elements.submitText.textContent = 'جاري طلب إذن الموقع...';
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    (error) => {
                        let errorMessage;
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "رفض المستخدم إذن الموقع الجغرافي. لا يمكن تسجيل الحضور.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "معلومات الموقع غير متوفرة حالياً.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "انتهت مهلة طلب الموقع الجغرافي.";
                                break;
                            default:
                                errorMessage = "حدث خطأ غير معروف أثناء الحصول على الموقع.";
                                break;
                        }
                        reject(new Error(errorMessage));
                    }, options
                );
            });
        }

        // معالجة إرسال النموذج
        elements.attendanceForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            elements.submitButton.disabled = true;
            elements.loadingSpinner.classList.remove('hidden');
            
            try {
                // الخطوة 1: الحصول على الموقع الجغرافي
                const location = await getGeolocation();

                elements.submitText.textContent = 'جاري إرسال البيانات...';

                const dataToSend = {
                    email: elements.emailInput.value,
                    doctorName: elements.doctorNameInput.value,
                    latitude: location.lat,
                    longitude: location.lng,
                    accuracy: location.accuracy
                };
                
                // الخطوة 2: إرسال البيانات إلى Google App Script
                const response = await fetch(APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

if (!response.ok) {
                    throw new Error(خطأ في استجابة الخادم: ${response.status});
                }

                const result = await response.json();
                
                // الخطوة 3: عرض النتيجة بناءً على رد App Script
                if (result.success === true) {
                    showStatus(true, result.message); // تم التسجيل والرسالة بها اسم الوحدة
                } else if (result.success === false) {
                    showStatus(false, 'لم يتم التسجيل', result.message || 'المسافة تتجاوز الحد المسموح به.'); // غير موجود بالمكان
                } else {
                    showStatus(false, 'رد غير متوقع من الخادم.', 'الرجاء مراجعة كود App Script.');
                }

            } catch (error) {
                console.error("Attendance Submission Error:", error);
                if (error.message.includes('رفض المستخدم إذن الموقع')) {
                    showStatus(false, 'لا يمكن التسجيل', 'يرجى تفعيل الموقع الجغرافي والسماح بالوصول.');
                } else {
                    showStatus(false, 'حدث خطأ غير متوقع', error.message);
                }
            } finally {
                elements.submitButton.disabled = false;
                elements.submitText.textContent = 'تسجيل الحضور';
                elements.loadingSpinner.classList.add('hidden');
            }
        });

        // =================================================================
        //                 * تهيئة التطبيق عند التحميل *
        // =================================================================
        window.onload = function () {
            // تهيئة خدمة تسجيل الدخول بجوجل
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true
            });

            // عرض زر جوجل
            google.accounts.id.renderButton(
                document.getElementById("google-button-container"), {
                    type: "standard",
                    theme: "outline",
                    size: "large",
                    text: "signin_with",
                    locale: "ar",
                    width: "380"
                }
            );
            
            updateUI();
        }
    </script>
</body>
</html>
